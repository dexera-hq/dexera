name: ci

on:
  pull_request:
  push:
    branches: [main]

concurrency:
  group: ci-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  CI: true

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      js: ${{ steps.filter.outputs.js }}
      go: ${{ steps.filter.outputs.go }}
      rust: ${{ steps.filter.outputs.rust }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            js:
              - "apps/**"
              - "edge/workers/**"
              - "packages/**"
              - "services/indexer/**"
              - "package.json"
              - "pnpm-lock.yaml"
              - "pnpm-workspace.yaml"
              - "turbo.json"
              - "Makefile"
              - "tooling/dev/smoke.sh"
              - "tooling/dev/check-prereqs.sh"
              - ".github/workflows/ci.yml"
            go:
              - "services/**/*.go"
              - "services/**/go.mod"
              - "services/**/go.sum"
              - "tooling/dev/run-go-tests.sh"
              - "Makefile"
              - ".github/workflows/ci.yml"
            rust:
              - "services/core/**"
              - "tooling/dev/run-rust-tests.sh"
              - "Makefile"
              - ".github/workflows/ci.yml"

  js-ts:
    name: JS/TS (${{ matrix.task.name }})
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: changes
    if: needs.changes.outputs.js == 'true'
    strategy:
      fail-fast: false
      matrix:
        task:
          - name: Lint
            id: lint
            cmd: make lint
          - name: Typecheck
            id: typecheck
            cmd: make typecheck
          - name: Test
            id: test
            cmd: make test
          - name: Smoke
            id: smoke
            cmd: pnpm smoke
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.4
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Cache Turborepo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ matrix.task.id }}-${{ github.ref_name }}-${{ hashFiles('turbo.json', 'pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-turbo-${{ matrix.task.id }}-${{ github.ref_name }}-
            ${{ runner.os }}-turbo-${{ matrix.task.id }}-

      - name: Install deps
        run: pnpm install --frozen-lockfile --prefer-offline
      - name: Run ${{ matrix.task.name }}
        run: ${{ matrix.task.cmd }}

  go:
    name: Go
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: changes
    if: needs.changes.outputs.go == 'true'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.23.x"
          cache: true
          cache-dependency-path: |
            services/**/go.mod
            services/**/go.sum

      - name: Run go tests
        run: ./tooling/dev/run-go-tests.sh

  rust:
    name: Rust
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust build
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "services/core -> target"

      - name: Rust fmt
        run: |
          cd services/core
          cargo fmt --all -- --check
      - name: Rust clippy
        run: |
          cd services/core
          cargo clippy --workspace --all-targets -- -D warnings
      - name: Rust tests
        run: ./tooling/dev/run-rust-tests.sh

  required:
    name: Required CI
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()
    needs:
      - changes
      - js-ts
      - go
      - rust
    steps:
      - name: Enforce required checks
        env:
          CHANGES_RESULT: ${{ needs.changes.result }}
          JS_RESULT: ${{ needs['js-ts'].result }}
          GO_RESULT: ${{ needs.go.result }}
          RUST_RESULT: ${{ needs.rust.result }}
        run: |
          echo "changes: $CHANGES_RESULT"
          echo "js-ts: $JS_RESULT"
          echo "go: $GO_RESULT"
          echo "rust: $RUST_RESULT"

          if [ "$CHANGES_RESULT" != "success" ]; then
            echo "changes job must succeed"
            exit 1
          fi

          for result in "$JS_RESULT" "$GO_RESULT" "$RUST_RESULT"; do
            if [ "$result" = "failure" ] || [ "$result" = "cancelled" ]; then
              echo "one of the CI jobs failed or was cancelled"
              exit 1
            fi
          done

          echo "all required jobs passed (or were correctly skipped)"
